<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusConnect Plus | Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e3a8a',
                        'secondary-gray': '#f3f4f6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }

        const SECURE_SERVICE_URL = "http://127.0.0.1:8081";
        const SSO_LOGIN_URL = "http://127.0.0.1:8000/sso-login";
        const CLIENT_ID = "campusconnect-client-2";
        const REQUESTED_SCOPES = "profile email student_academics";

        let currentUserName = "Student";
        let secureContent = "Connect your SSO account to load personalized data from CampusConnect Plus.";
        let currentProfile = null;
        let grantedScopes = [];
        let resourceDetails = null;
        let consentDenied = false;
        let hasSSOData = false;
        let blockedState = false;
        let blockedNotice = "";
        let loginNotice = "";

        const defaultResourceDetails = {
            title: "Protected Resource (App 2)",
            content: "Authorize with SSO to view personalized content from the second demo app."
        };

        const ensureArray = (value) => {
            if (Array.isArray(value)) return value;
            if (!value) return [];
            return [value];
        };

        const formatScopeLabel = (scope) => {
            if (!scope || typeof scope !== "string") return "Unknown";
            const cleaned = scope.replace(/[_-]+/g, " ").trim();
            return cleaned
                .split(" ")
                .filter(Boolean)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(" ");
        };

        const deriveDisplayName = (rawName, email) => {
            if (rawName && rawName.trim().length > 0) return rawName.trim();
            if (email && email.length > 0) {
                const prefix = email.split("@")[0] || "student";
                return prefix.charAt(0).toUpperCase() + prefix.slice(1);
            }
            return "Student";
        };

        const normalizeProfile = (rawProfile = {}, fallbackEmail = "student@example.com", fallbackName = "Student") => {
            const email = rawProfile.email || fallbackEmail;
            return {
                name: deriveDisplayName(rawProfile.name || fallbackName, email),
                email,
                rollNo: rawProfile.rollNo || rawProfile.roll_no || "Not shared",
                branch: rawProfile.branch || "Not shared",
                semester: rawProfile.semester || "Not shared"
            };
        };

        const applyProfileState = ({ profile, scopes, resource, statusMessage, isSSO = false }) => {
            const normalized = normalizeProfile(
                profile,
                profile?.email || "student@example.com",
                profile?.name || "Student"
            );
            currentProfile = normalized;
            currentUserName = normalized.name;
            grantedScopes = ensureArray(scopes).map(scope => formatScopeLabel(scope));
            if (!isSSO) grantedScopes = [];
            resourceDetails = resource || defaultResourceDetails;
            secureContent = statusMessage || "Secure data synced successfully from CampusConnect Plus.";
            consentDenied = false;
            hasSSOData = !!isSSO;
        };

        function getSSOToken() {
            return localStorage.getItem('sso_jwt_token_app2');
        }

        function setSSOToken(token) {
            localStorage.setItem('sso_jwt_token_app2', token);
        }

        const resetBlockedState = () => {
            blockedState = false;
            blockedNotice = "";
        };

        const resetLoginNotice = () => {
            loginNotice = "";
        };

        function clearSSOToken(message, options = {}) {
            localStorage.removeItem('sso_jwt_token_app2');
            currentUserName = "Student";
            secureContent = message || "Connect your SSO account to load personalized data from CampusConnect Plus.";
            currentProfile = null;
            grantedScopes = [];
            resourceDetails = null;
            consentDenied = false;
            hasSSOData = false;
            if (options.blocked) {
                blockedState = true;
                blockedNotice = secureContent;
            } else {
                resetBlockedState();
            }
            if (options.loginNotice) {
                loginNotice = options.loginNotice;
            } else if (!options.preserveNotice) {
                resetLoginNotice();
            }
        }

        const renderGrantedScopes = () => {
            if (!Array.isArray(grantedScopes) || grantedScopes.length === 0) {
                return `<span class="text-sm text-indigo-100/80">No scopes granted yet.</span>`;
            }
            return grantedScopes
                .map(scope => `<span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-xs font-semibold">${scope}</span>`)
                .join("");
        };

        const renderSecureContent = () => {
            const profile = currentProfile || normalizeProfile({}, "student@example.com");
            const scopesMarkup = renderGrantedScopes();
            const resource = resourceDetails || defaultResourceDetails;
            const statusStyle = consentDenied ? "text-red-100" : "text-indigo-50";
            const statusMessage = secureContent;

            const consentCta = consentDenied
                ? `<button onclick="handleSsoRedirect()" class="mt-3 inline-flex items-center px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-xs font-semibold rounded-lg transition">
                        Try Again &amp; Grant Access
                   </button>`
                : "";

            return `
                <div class="space-y-4 text-sm text-indigo-100/90">
                    <div class="bg-white/10 border border-white/20 rounded-lg p-4">
                        <p class="text-xs uppercase tracking-wide text-indigo-200">Status</p>
                        <p class="text-sm ${statusStyle} mt-1">${statusMessage}</p>
                        ${consentCta}
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="bg-white/20 border border-white/30 rounded-lg p-4">
                            <p class="text-xs uppercase tracking-wide text-indigo-200">Full Name</p>
                            <p class="text-lg font-semibold text-white">${profile.name}</p>
                        </div>
                        <div class="bg-white/20 border border-white/30 rounded-lg p-4">
                            <p class="text-xs uppercase tracking-wide text-indigo-200">Email</p>
                            <p class="text-lg font-semibold text-white">${profile.email}</p>
                        </div>
                        <div class="bg-white/20 border border-white/30 rounded-lg p-4">
                            <p class="text-xs uppercase tracking-wide text-indigo-200">Roll Number</p>
                            <p class="text-lg font-semibold text-white">${profile.rollNo}</p>
                        </div>
                        <div class="bg-white/20 border border-white/30 rounded-lg p-4">
                            <p class="text-xs uppercase tracking-wide text-indigo-200">Branch & Semester</p>
                            <p class="text-lg font-semibold text-white">${profile.branch}${profile.semester && profile.semester !== "Not shared" ? ` Â· Sem ${profile.semester}` : ""}</p>
                        </div>
                    </div>
                    ${hasSSOData ? `
                    <div class="bg-white/10 border border-white/20 rounded-lg p-4">
                        <p class="text-xs uppercase tracking-wide text-indigo-200">Granted Scopes</p>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${scopesMarkup}
                        </div>
                    </div>` : ""}
                    <div class="bg-white/10 border border-white/20 rounded-lg p-4">
                        <p class="text-xs uppercase tracking-wide text-indigo-200">Secure Resource</p>
                        <p class="text-sm text-indigo-50 font-semibold mt-1">${resource.title}</p>
                        <p class="text-xs text-indigo-100/80 mt-2 leading-relaxed">${resource.content}</p>
                    </div>
                </div>
            `;
        };

        const dashboardContent = () => `
            <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 px-6 bg-white shadow-lg rounded-xl mb-8">
                    <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l10 5v14l-10 5-10-5V7z"/><path d="M12 2v20"/><path d="M22 7l-10 5-10-5"/></svg>
                        <h1 class="text-2xl font-extrabold text-gray-800">CampusConnect Plus Dashboard</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-600 hidden md:block">Hello, ${currentUserName}!</span>
                        <img src="https://placehold.co/40x40/1d4ed8/ffffff?text=${currentUserName.charAt(0)}" alt="Profile Picture" class="w-10 h-10 rounded-full border-2 border-primary-blue shadow-md object-cover">
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                            Logout
                        </button>
                    </div>
                </header>

                <section class="mb-8 p-6 bg-primary-blue text-white rounded-xl shadow-xl">
                    <p class="text-lg opacity-90 mb-4">Welcome to the second demo app protected by SSO.</p>
                    <div class="mt-4 p-4 border border-blue-300 bg-blue-700 rounded-lg">
                        <p class="text-sm font-semibold mb-3">Protected Resource Access Status (App 2):</p>
                        <div class="text-xs sm:text-sm leading-relaxed">
                            ${renderSecureContent()}
                        </div>
                    </div>
                </section>
            </div>
        `;

        const loginFormHtml = `
            <div class="flex items-center justify-center h-full">
                <div class="w-full max-w-md">
                    <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-primary-blue">
                        <div class="text-center mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-primary-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l10 5v14l-10 5-10-5V7z"/><path d="M12 2v20"/><path d="M22 7l-10 5-10-5"/></svg>
                            <h2 class="mt-4 text-3xl font-extrabold text-gray-900">Sign in to CampusConnect Plus</h2>
                            <p class="mt-2 text-sm text-gray-600">Secondary SSO-protected portal</p>
                        </div>
                        <div id="status-message" class="text-sm text-center text-gray-600 mb-4">Use SSO to connect this app to your SSO account.</div>
                        <div class="space-y-6">
                            <button onclick="handleSsoRedirect()"
                                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">
                                Login via Single Sign-On (SSO)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        function showBlockedState(message) {
            const notice = message || "Your access to CampusConnect Plus has been restricted by the administrator.";
            clearSSOToken(notice, { blocked: true });
            alert(notice);
            window.location.hash = '#/login';
        }

        function handleSsoRedirect() {
            const currentAppUrl = window.location.href.split('#')[0];
            const redirectUri = `${currentAppUrl}#/sso-success`;
            consentDenied = false;
            resetLoginNotice();
            resetBlockedState();
            currentProfile = null;
            grantedScopes = [];
            secureContent = "Redirecting to the SSO service for CampusConnect Plus...";
            window.location.href = `${SSO_LOGIN_URL}?redirect_uri=${encodeURIComponent(redirectUri)}&client_id=${encodeURIComponent(CLIENT_ID)}&scope=${encodeURIComponent(REQUESTED_SCOPES)}`;
        }

        async function fetchSecureData() {
            const token = getSSOToken();
            if (!token) {
                logout();
                return;
            }

            try {
                const response = await fetch(`${SECURE_SERVICE_URL}/secure-data`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let data = {};
                try {
                    data = await response.json();
                } catch {
                    data = {};
                }
                if (!response.ok) {
                    const errMsg = data.detail || data.error || data.message || 'Token verification failed.';
                    throw new Error(errMsg);
                }

                applyProfileState({
                    profile: data.user || { email: data.access_granted_to },
                    scopes: data.granted_scopes || data.scopes || [],
                    resource: data.resource_details,
                    statusMessage: `App 2 secure data synced at ${new Date().toLocaleTimeString()}.`,
                    isSSO: true
                });

                window.location.hash = '#/dashboard';
                router();
            } catch (error) {
                console.error("[App2] Secure Data Fetch Error:", error.message);
                const lowerMsg = (error.message || "").toLowerCase();
                if (lowerMsg.includes("application blocked")) {
                    clearSSOToken("This application has been blocked by the administrator.");
                    alert("CampusConnect Plus has been blocked by the administrator. Please contact support.");
                    window.location.hash = '#/login';
                    return;
                }
                if (lowerMsg.includes("user access blocked")) {
                    clearSSOToken();
                    showBlockedState("Your account has been blocked for this application. Displaying demo data.");
                    return;
                }
                secureContent = `Error (App 2): ${error.message}`;
                clearSSOToken(secureContent);
                window.location.hash = '#/login';
            }
        }

        function router() {
            const mainContainer = document.getElementById('main-container');
            const hash = window.location.hash;

            if (hash.startsWith('#/sso-success')) {
                const params = new URLSearchParams(hash.substring(hash.indexOf('?') + 1));
                const token = params.get('token');
                const error = params.get('error');

                mainContainer.innerHTML = `<div class="p-8 text-center text-xl text-primary-blue">Processing SSO login for App 2...</div>`;
                window.history.replaceState(null, null, window.location.pathname + '#/dashboard-loading');

                if (error === 'access_denied') {
                    clearSSOToken("You denied the data-sharing request for App 2.");
                    consentDenied = true;
                    window.location.hash = '#/dashboard';
                    return;
                }

                if (error === 'invalid_credentials') {
                    const notice = "Invalid email or password. Please try again.";
                    alert(notice);
                    clearSSOToken(notice, { loginNotice: notice, preserveNotice: true });
                    window.location.hash = '#/login';
                    return;
                }

                if (error === 'app_blocked') {
                    clearSSOToken("CampusConnect Plus has been blocked by the administrator.");
                    alert("CampusConnect Plus has been blocked by the administrator. Please contact support.");
                    window.location.hash = '#/login';
                    return;
                }

                if (error === 'user_blocked') {
                    clearSSOToken();
                    showBlockedState("Your account has been blocked for CampusConnect Plus. Displaying demo data.");
                    return;
                }

                if (token) {
                    setSSOToken(token);
                    fetchSecureData();
                } else {
                    secureContent = "SSO Failed: Token missing in redirect URL for App 2.";
                    clearSSOToken(secureContent);
                    window.location.hash = '#/login';
                }
            } else if (getSSOToken() && hash === '#/dashboard') {
                mainContainer.innerHTML = dashboardContent();
                document.title = "CampusConnect Plus | Dashboard";
            } else {
                mainContainer.innerHTML = loginFormHtml;
                const statusMsg = mainContainer.querySelector('#status-message');
                if (statusMsg) {
                    if (loginNotice) {
                        statusMsg.textContent = loginNotice;
                        statusMsg.classList.add('text-red-500', 'font-semibold');
                    } else if (blockedState || consentDenied) {
                        statusMsg.textContent = blockedState ? (blockedNotice || secureContent) : secureContent;
                        statusMsg.classList.add('text-red-500', 'font-semibold');
                    } else {
                        statusMsg.textContent = "Use SSO to connect this app to your SSO account.";
                        statusMsg.classList.remove('text-red-500', 'font-semibold');
                    }
                }
                document.title = "CampusConnect Plus | Login";
            }
        }

        function logout() {
            clearSSOToken();
            window.location.hash = '#/login';
        }

        window.addEventListener('hashchange', router);

        window.onload = function () {
            if (getSSOToken()) {
                fetchSecureData();
            } else if (!window.location.hash) {
                window.location.hash = '#/login';
            }
            router();
            window.handleSsoRedirect = handleSsoRedirect;
            window.logout = logout;
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    </style>
</head>
<body class="bg-secondary-gray min-h-screen font-sans">
    <div id="main-container" class="min-h-screen w-full"></div>
</body>
</html>


