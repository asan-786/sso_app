<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusConnect | Student Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af',
                        'secondary-gray': '#f3f4f6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }

        // --- Configuration and State ---
        // Base URL for the Third-Party secure service (your Flask app)
        const SECURE_SERVICE_URL = "http://127.0.0.1:8080";
        // Base URL for the main SSO login page (change port if necessary)
        // Point to the standalone SSO login page served on port 8000
        const SSO_LOGIN_URL = "http://127.0.0.1:8000/sso-login";

        let currentUserName = "Student"; // State for displaying user name
        let secureContent = "Click 'Logout' and 'Login via SSO' to load secure data."; // State for protected content

        // --- Helper Functions for Token Management ---

        function getSSOToken() {
            return localStorage.getItem('sso_jwt_token');
        }

        function setSSOToken(token) {
            localStorage.setItem('sso_jwt_token', token);
        }

        function clearSSOToken() {
            localStorage.removeItem('sso_jwt_token');
            currentUserName = "Student";
            secureContent = "Click 'Logout' and 'Login via SSO' to load secure data.";
        }

        // --- Content Templates ---

        // 1. Dashboard Content (HTML Template String)
        const dashboardContent = () => `
            <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                <!-- Header and Navigation Bar -->
                <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 px-6 bg-white shadow-lg rounded-xl mb-8">
                    <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                        <!-- University Logo/Name -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-primary-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l10 5v14l-10 5-10-5V7z"/><path d="M12 2v20"/><path d="M22 7l-10 5-10-5"/></svg>
                        <h1 class="text-2xl font-extrabold text-gray-800">CampusConnect Dashboard</h1>
                    </div>

                    <!-- Profile and Logout Button -->
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-600 hidden md:block">Hello, ${currentUserName}!</span>
                        <img src="https://placehold.co/40x40/4f46e5/ffffff?text=${currentUserName.charAt(0)}" alt="Profile Picture" class="w-10 h-10 rounded-full border-2 border-primary-blue shadow-md object-cover">
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                            Logout
                        </button>
                    </div>
                </header>

                <!-- Welcome Banner / Secure Data Section -->
                <section class="mb-8 p-6 bg-primary-blue text-white rounded-xl shadow-xl">
                    // <h2 class="text-3xl font-bold mb-2">Welcome Back, <!--${currentUserName}-->!</h2>
                    <p class="text-lg opacity-90 mb-4">You have important updates regarding your Fall 2025 semester.</p>
                    
                    <!-- Secure Data from Backend -->
                    <div class="mt-4 p-4 border border-blue-300 bg-blue-700 rounded-lg">
                        <p class="text-sm font-semibold mb-1">Protected Resource Access Status:</p>
                        <p class="text-xs font-mono whitespace-pre-wrap">${secureContent}</p>
                    </div>
                </section>

                <!-- Key Navigation/Quick Links (Rest of the Dashboard) -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10">
                    <a href="#" class="bg-white p-4 flex flex-col items-center rounded-xl shadow-md hover:shadow-lg transition duration-300 transform hover:-translate-y-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                        <span class="text-sm font-semibold text-gray-700 text-center">Courses</span>
                    </a>
                    <a href="#" class="bg-white p-4 flex flex-col items-center rounded-xl shadow-md hover:shadow-lg transition duration-300 transform hover:-translate-y-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/></svg>
                        <span class="text-sm font-semibold text-gray-700 text-center">Grades</span>
                    </a>
                    <a href="#" class="bg-white p-4 flex flex-col items-center rounded-xl shadow-md hover:shadow-lg transition duration-300 transform hover:-translate-y-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        <span class="text-sm font-semibold text-gray-700 text-center">Finance</span>
                    </a>
                    <a href="#" class="bg-white p-4 flex flex-col items-center rounded-xl shadow-md hover:shadow-lg transition duration-300 transform hover:-translate-y-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-500 mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                        <span class="text-sm font-semibold text-gray-700 text-center">Library</span>
                    </a>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Column 1: Upcoming Schedule / To-Do (omitted for brevity) -->
                    <div class="lg:col-span-2 space-y-8">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-primary-blue">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Your Schedule</h3>
                            <p class="text-gray-500">Schedule details go here...</p>
                        </div>
                    </div>
                    <!-- Column 2: Announcements (omitted for brevity) -->
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Announcements</h3>
                            <p class="text-gray-500">Announcement details go here...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // 2. Login Form Content (HTML Template String)
        const loginFormHtml = `
            <div class="flex items-center justify-center h-full">
                <div class="w-full max-w-md">
                    <div class="bg-white p-8 rounded-xl shadow-2xl border-t-4 border-primary-blue">
                        <div class="text-center mb-6">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-primary-blue" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l10 5v14l-10 5-10-5V7z"/><path d="M12 2v20"/><path d="M22 7l-10 5-10-5"/></svg>
                            <h2 class="mt-4 text-3xl font-extrabold text-gray-900">Sign in to CampusConnect</h2>
                            <p class="mt-2 text-sm text-gray-600">Your portal to academic life</p>
                        </div>
                        <div id="status-message" class="text-sm text-center text-gray-600 mb-4">Use the SSO button or the local credentials to test the dashboard.</div>
                        
                        <div class="space-y-6">
                            <form onsubmit="event.preventDefault(); simulateLogin();" class="space-y-6">
                            <div>
                                <label for="email" class="block text-sm font-medium text-gray-700">Student Email</label>
                                <input id="email" type="email" required value="test@user.com" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input id="password" type="password" required value="password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue">
                            </div>
                            <div id="error-message" class="hidden text-sm text-center text-red-500 font-semibold transition duration-150"></div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-primary-blue hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition duration-200">
                                Simulated Login (for Testing)
                            </button>
                            </form>
                            <div class="separator text-sm font-semibold text-gray-500 relative flex justify-center items-center my-4">
                                <span class="bg-white px-2 z-10">OR</span>
                                <hr class="absolute w-full border-t border-gray-300">
                            </div>
                            <button onclick="handleSsoRedirect()"
                                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200">
                                Login via Single Sign-On (SSO)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // --- Core Functions ---
        
        // Function to simulate a successful SSO flow for testing when the external SSO is unavailable.
        function simulateLogin() {
            setSSOToken('simulated_jwt_token_for_testing');
            fetchSecureData(); 
        }


        // 1. Initiate SSO Login Flow
        function handleSsoRedirect() {
            // Use window.location.href to get the full URL including the protocol, domain, and path.
            const currentAppUrl = window.location.href.split('#')[0]; // Remove hash if present
            
            // The redirect URI must point to where the token handler starts: #/sso-success
            const redirectUri = `${currentAppUrl}#/sso-success`;
            
            window.location.href = `${SSO_LOGIN_URL}?redirect_uri=${encodeURIComponent(redirectUri)}`;
        }

        // 2. Load Secure Data from Flask Backend
        async function fetchSecureData() {
            const token = getSSOToken();
            if (!token) {
                // If no token, redirect to login
                logout();
                return;
            }

            const statusEl = document.getElementById('status-message');
            if (statusEl) statusEl.textContent = "Fetching secure data...";

            try {
                // Implement exponential backoff for API call
                let response = null;
                let data = null;
                const maxRetries = 3;
                
                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(`${SECURE_SERVICE_URL}/secure-data`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    data = await response.json();

                    if (response.ok) {
                        break; // Success
                    }

                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Throw error if all retries fail
                        throw new Error(data.message || 'Token verification failed after multiple retries.');
                    }
                }
                
                // Success: Extract user name and protected content
                let userEmail = data.access_granted_to || 'test@user.com';
                const emailPrefix = userEmail.split('@')[0];
                currentUserName = emailPrefix.charAt(0).toUpperCase() + emailPrefix.slice(1);
                secureContent = JSON.stringify(data.resource_details, null, 2);
                window.location.hash = '#/dashboard';
                
            } catch (error) {
                console.error("Secure Data Fetch Error:", error.message);
                
                // Detailed error message for the user
                let userErrorMessage = "An unexpected error occurred. Please check your network or try Simulated Login.";
                if (error.message.includes("Token verification failed")) {
                    userErrorMessage = "SSO token verification failed. Your token may be invalid or expired.";
                } else if (error.message.includes("Failed to fetch")) {
                    userErrorMessage = `Cannot connect to the backend secure service (${SECURE_SERVICE_URL}). Ensure your Python server is running on port 8080.`;
                }
                
                secureContent = `Error: Access Denied! ${userErrorMessage}`;
                clearSSOToken();
                window.location.hash = '#/login'; // Force login page on failure
            }
        }

        // 3. Main Router
        function router() {
            const mainContainer = document.getElementById('main-container');
            const appFooter = document.getElementById('app-footer');
            const hash = window.location.hash;

            // Clear layout classes
            mainContainer.classList.remove('flex', 'items-center', 'justify-center', 'min-h-screen', 'max-w-7xl', 'mx-auto', 'p-4');
            appFooter.classList.add('hidden');
            
            if (hash.startsWith('#/sso-success')) {
                // SSO REDIRECT PATH
                const params = new URLSearchParams(hash.substring(hash.indexOf('?') + 1));
                const token = params.get('token');

                mainContainer.innerHTML = `<div class="p-8 text-center text-xl text-primary-blue">Processing SSO login...</div>`;

                // Remove the token from the hash to clean the URL bar
                // We navigate to a temporary loading state to prevent the router loop
                window.history.replaceState(null, null, window.location.pathname + '#/dashboard-loading'); 


                if (token) {
                    setSSOToken(token);
                    // Now that we have the token, fetch the secure data and redirect to dashboard
                    fetchSecureData();
                } else {
                    // Handle missing token
                    mainContainer.innerHTML = `<div class="p-8 text-center text-xl text-red-500">SSO Failed: Token missing in redirect URL.</div>`;
                    window.location.hash = '#/login';
                }

            } else if (getSSOToken() && hash === '#/dashboard') {
                // DASHBOARD VIEW (Requires valid token and has been loaded)
                mainContainer.innerHTML = dashboardContent();
                appFooter.classList.remove('hidden');
                mainContainer.classList.add('max-w-7xl', 'mx-auto');
                document.title = "CampusConnect | Student Dashboard";
            } else if (getSSOToken() && hash !== '#/login') {
                 // Token exists but not yet on dashboard (e.g. user manually navigates to index.html)
                 // Start the data fetching process
                fetchSecureData();
                mainContainer.innerHTML = `<div class="p-8 text-center text-xl text-primary-blue min-h-screen flex items-center justify-center">Loading Dashboard...</div>`;

            } else {
                // LOGIN VIEW (Default or explicitly navigating to #/login)
                mainContainer.innerHTML = loginFormHtml;
                mainContainer.classList.add('flex', 'items-center', 'justify-center', 'min-h-screen', 'p-4');
                document.title = "CampusConnect | Student Login";
            }
        }

        // 4. Logout Function
        function logout() {
            clearSSOToken();
            window.location.hash = '#/login';
        }

        // --- Event Listeners and Initialization ---

        window.addEventListener('hashchange', router);

        window.onload = function() {
            // Initial load check
            if (getSSOToken() && window.location.hash !== '#/dashboard') {
                // If the user has a token but didn't land on dashboard, try to load it.
                fetchSecureData();
            } else if (!getSSOToken() && !window.location.hash) {
                // If no token and no hash, default to login.
                window.location.hash = '#/login';
            }
            router();
            
            // Make functions globally available for inline HTML events
            window.handleSsoRedirect = handleSsoRedirect;
            window.logout = logout;
            window.simulateLogin = simulateLogin;
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        .separator {
            position: relative;
            text-align: center;
        }
        .separator hr {
            z-index: 5;
        }
        .separator span {
            z-index: 10;
        }
    </style>
</head>
<body class="bg-secondary-gray min-h-screen font-sans">

    <!-- Main Application Container: Content will be dynamically replaced by JavaScript -->
    <div id="main-container" class="min-h-screen w-full">
        <!-- Login Form or Dashboard will be injected here -->
    </div>

    <!-- Footer - Hidden during login, shown on dashboard -->
    <footer id="app-footer" class="mt-10 py-4 text-center text-sm text-gray-500 border-t border-gray-200 hidden">
        <p>&copy; 2025 CampusConnect University Application. All rights reserved. <span class="hidden sm:inline">User ID: <span class="font-mono">student_sso_user</span></span></p>
    </footer>

</body>
</html>
